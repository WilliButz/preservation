<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Preservation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Preservation</a></li><li class="chapter-item expanded "><a href="configuration-options.html"><strong aria-hidden="true">1.</strong> Configuration Options</a></li><li class="chapter-item expanded "><a href="examples.html"><strong aria-hidden="true">2.</strong> Examples</a></li><li class="chapter-item expanded "><a href="impermanence.html"><strong aria-hidden="true">3.</strong> Impermanence</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="impermanence-comparison.html"><strong aria-hidden="true">3.1.</strong> Comparison</a></li><li class="chapter-item expanded "><a href="impermanence-migration.html"><strong aria-hidden="true">3.2.</strong> Migration</a></li></ol></li><li class="chapter-item expanded "><a href="library-and-testing.html"><strong aria-hidden="true">4.</strong> Library and Testing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Preservation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/willibutz/preservation" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="preservation"><a class="header" href="#preservation">Preservation</a></h1>
<p>Nix tooling to enable declarative management of non-volatile system state.</p>
<p>Inspired and heavily influenced by <a href="https://github.com/nix-community/impermanence">impermanence</a> but not
meant to be a drop-in replacement.</p>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>Docs are available at <a href="https://willibutz.github.io/preservation">https://willibutz.github.io/preservation</a></p>
<h2 id="work-in-progress"><a class="header" href="#work-in-progress">Work in Progress</a></h2>
<p>üöß still under construction üöß</p>
<p>Check out <a href="../../tests/basic.nix">the test</a> for a usage example üëÄ</p>
<p>Depends on <a href="https://github.com/NixOS/nixpkgs/pull/307528">https://github.com/NixOS/nixpkgs/pull/307528</a> (merged, available on nixos-unstable).</p>
<h2 id="why"><a class="header" href="#why">Why?</a></h2>
<p>This aims to provide a declarative state management solution for NixOS systems without resorting to
interpreters to do the heavy lifting. This should enable impermanence-like state management on
an "interpreter-less" NixOS system.</p>
<p>Related:</p>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/issues/265640">https://github.com/NixOS/nixpkgs/issues/265640</a></li>
<li><a href="https://github.com/nix-community/projects/blob/main/proposals/nixpkgs-security-phase2.md#boot-chain-security">https://github.com/nix-community/projects/blob/main/proposals/nixpkgs-security-phase2.md#boot-chain-security</a></li>
</ul>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>This project is released under the terms of the MIT License. See <a href="../.././LICENSE">LICENSE</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="preservationenable"><a class="header" href="#preservationenable">preservation.enable</a></h2>
<p>Whether to enable the preservation module.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Example:</em>
<code>true</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveat"><a class="header" href="#preservationpreserveat">preservation.preserveAt</a></h2>
<p>Specify a set of locations and the corresponding state that
should be preserved there.</p>
<p><em>Type:</em>
attribute set of (submodule)</p>
<p><em>Default:</em>
<code>{ }</code></p>
<p><em>Example:</em></p>
<pre><code class="language-nix">{
  "/state" = {
    directories = [ "/var/lib/someservice" ];
    files = [
      {
        file = "/etc/wpa_supplicant.conf";
        how = "symlink";
      }
      {
        file = "/etc/machine-id";
        inInitrd = true;
      }
    ];
    users = {
      alice.directories = [ ".rabbit_hole" ];
      butz = {
        files = [
          {
            file = ".config/foo";
            mode = "0600";
          }
          "bar"
        ];
        directories = [ "unshaved_yaks" ];
      };
    };
  };
}
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectories"><a class="header" href="#preservationpreserveatnamedirectories">preservation.preserveAt.&lt;name&gt;.directories</a></h2>
<p>Specify a list of directories that should be preserved.
The paths are interpreted as absolute paths.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code>[
  "/var/lib/someservice"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesconfigureparent"><a class="header" href="#preservationpreserveatnamedirectoriesconfigureparent">preservation.preserveAt.&lt;name&gt;.directories.*.configureParent</a></h2>
<p>Specify whether the parent directory of this directory shall be configured with
custom ownership and permissions.</p>
<p>By default, missing parent directories are always created with ownership
<code>root:root</code> and mode <code>0755</code>, as described in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a>.</p>
<p>Ownership and mode may be configured through the options
<code>parent.user</code>,
<code>parent.group</code>,
<code>parent.mode</code>.</p>
<p>Defaults to <code>true</code> when <code>how</code> is set to <code>symlink</code> and
<code>user</code> is not <code>root</code>.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriescreatelinktarget"><a class="header" href="#preservationpreserveatnamedirectoriescreatelinktarget">preservation.preserveAt.&lt;name&gt;.directories.*.createLinkTarget</a></h2>
<p>Only used when <code>how</code> is set to <code>symlink</code>.</p>
<p>Specify whether to create an empty directory with the specified ownership
and permissions as target of the symlink.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesdirectory"><a class="header" href="#preservationpreserveatnamedirectoriesdirectory">preservation.preserveAt.&lt;name&gt;.directories.*.directory</a></h2>
<p>Specify the path to the directory that should be preserved.</p>
<p><em>Type:</em>
string</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesgroup"><a class="header" href="#preservationpreserveatnamedirectoriesgroup">preservation.preserveAt.&lt;name&gt;.directories.*.group</a></h2>
<p>Specify the group that owns the directory.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectorieshow"><a class="header" href="#preservationpreserveatnamedirectorieshow">preservation.preserveAt.&lt;name&gt;.directories.*.how</a></h2>
<p>Specify how this directory should be preserved.</p>
<p><em>Type:</em>
one of ‚Äúbindmount‚Äù, ‚Äúsymlink‚Äù</p>
<p><em>Default:</em>
<code>"bindmount"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesininitrd"><a class="header" href="#preservationpreserveatnamedirectoriesininitrd">preservation.preserveAt.&lt;name&gt;.directories.*.inInitrd</a></h2>
<p>Whether to prepare preservation of this directory in initrd.</p>
<p><strong>Note:</strong> For most directories there is no need to enable this option.</p>
<p><strong>Important:</strong> Note that both owner and group for this directory need to be
available in the initrd for permissions to be set correctly.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesmode"><a class="header" href="#preservationpreserveatnamedirectoriesmode">preservation.preserveAt.&lt;name&gt;.directories.*.mode</a></h2>
<p>Specify the access mode of the directory.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesmountoptions"><a class="header" href="#preservationpreserveatnamedirectoriesmountoptions">preservation.preserveAt.&lt;name&gt;.directories.*.mountOptions</a></h2>
<p>Specify a list of mount options that should be used for this directory.
These options are only used when <code>how</code> is set to <code>bindmount</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em></p>
<pre><code>[
  "bind"
  "X-fstrim.notrim"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesmountoptionsname"><a class="header" href="#preservationpreserveatnamedirectoriesmountoptionsname">preservation.preserveAt.&lt;name&gt;.directories.*.mountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesmountoptionsvalue"><a class="header" href="#preservationpreserveatnamedirectoriesmountoptionsvalue">preservation.preserveAt.&lt;name&gt;.directories.*.mountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesparentgroup"><a class="header" href="#preservationpreserveatnamedirectoriesparentgroup">preservation.preserveAt.&lt;name&gt;.directories.*.parent.group</a></h2>
<p>Specify the group that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesparentmode"><a class="header" href="#preservationpreserveatnamedirectoriesparentmode">preservation.preserveAt.&lt;name&gt;.directories.*.parent.mode</a></h2>
<p>Specify the access mode of the parent directory of this file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesparentuser"><a class="header" href="#preservationpreserveatnamedirectoriesparentuser">preservation.preserveAt.&lt;name&gt;.directories.*.parent.user</a></h2>
<p>Specify the user that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"root"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamedirectoriesuser"><a class="header" href="#preservationpreserveatnamedirectoriesuser">preservation.preserveAt.&lt;name&gt;.directories.*.user</a></h2>
<p>Specify the user that owns the directory.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"root"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefiles"><a class="header" href="#preservationpreserveatnamefiles">preservation.preserveAt.&lt;name&gt;.files</a></h2>
<p>Specify a list of files that should be preserved.
The paths are interpreted as absolute paths.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code class="language-nix">[
  {
    file = "/etc/wpa_supplicant.conf";
    how = "symlink";
  }
  {
    file = "/etc/machine-id";
    inInitrd = true;
  }
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesconfigureparent"><a class="header" href="#preservationpreserveatnamefilesconfigureparent">preservation.preserveAt.&lt;name&gt;.files.*.configureParent</a></h2>
<p>Specify whether the parent directory of this file shall be configured with
custom ownership and permissions.</p>
<p>By default, missing parent directories are always created with ownership
<code>root:root</code> and mode <code>0755</code>, as described in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a>.</p>
<p>Ownership and mode may be configured through the options
<code>parent.user</code>,
<code>parent.group</code>,
<code>parent.mode</code>.</p>
<p>Defaults to <code>true</code> when <code>how</code> is set to <code>symlink</code> and
<code>user</code> is not <code>root</code>.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilescreatelinktarget"><a class="header" href="#preservationpreserveatnamefilescreatelinktarget">preservation.preserveAt.&lt;name&gt;.files.*.createLinkTarget</a></h2>
<p>Only used when <code>how</code> is set to <code>symlink</code>.</p>
<p>Specify whether to create an empty file with the specified ownership
and permissions as target of the symlink.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesfile"><a class="header" href="#preservationpreserveatnamefilesfile">preservation.preserveAt.&lt;name&gt;.files.*.file</a></h2>
<p>Specify the path to the file that should be preserved.</p>
<p><em>Type:</em>
string</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesgroup"><a class="header" href="#preservationpreserveatnamefilesgroup">preservation.preserveAt.&lt;name&gt;.files.*.group</a></h2>
<p>Specify the group that owns the file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefileshow"><a class="header" href="#preservationpreserveatnamefileshow">preservation.preserveAt.&lt;name&gt;.files.*.how</a></h2>
<p>Specify how this file should be preserved:</p>
<ol>
<li>
<p>Either a file is placed both on the volatile and on the
persistent volume, with a bind mount from the former to the
latter.</p>
</li>
<li>
<p>Or a symlink is created on the volatile volume, pointing
to the corresponding location on the persistent volume.</p>
</li>
</ol>
<p><em>Type:</em>
one of ‚Äúbindmount‚Äù, ‚Äúsymlink‚Äù</p>
<p><em>Default:</em>
<code>"bindmount"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesininitrd"><a class="header" href="#preservationpreserveatnamefilesininitrd">preservation.preserveAt.&lt;name&gt;.files.*.inInitrd</a></h2>
<p>Whether to prepare preservation of this file in the initrd.</p>
<p><strong>Note:</strong> For most files there is no need to enable this option.</p>
<p><code>/etc/machine-id</code> is an exception because it needs to
be populated/read very early.</p>
<p><strong>Important:</strong> Note that both owner and group for this file need to be
available in the initrd for permissions to be set correctly.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesmode"><a class="header" href="#preservationpreserveatnamefilesmode">preservation.preserveAt.&lt;name&gt;.files.*.mode</a></h2>
<p>Specify the access mode of the file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0644"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesmountoptions"><a class="header" href="#preservationpreserveatnamefilesmountoptions">preservation.preserveAt.&lt;name&gt;.files.*.mountOptions</a></h2>
<p>Specify a list of mount options that should be used for this file.
These options are only used when <code>how</code> is set to <code>bindmount</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em></p>
<pre><code>[
  "bind"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesmountoptionsname"><a class="header" href="#preservationpreserveatnamefilesmountoptionsname">preservation.preserveAt.&lt;name&gt;.files.*.mountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesmountoptionsvalue"><a class="header" href="#preservationpreserveatnamefilesmountoptionsvalue">preservation.preserveAt.&lt;name&gt;.files.*.mountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesparentgroup"><a class="header" href="#preservationpreserveatnamefilesparentgroup">preservation.preserveAt.&lt;name&gt;.files.*.parent.group</a></h2>
<p>Specify the group that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesparentmode"><a class="header" href="#preservationpreserveatnamefilesparentmode">preservation.preserveAt.&lt;name&gt;.files.*.parent.mode</a></h2>
<p>Specify the access mode of the parent directory of this file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesparentuser"><a class="header" href="#preservationpreserveatnamefilesparentuser">preservation.preserveAt.&lt;name&gt;.files.*.parent.user</a></h2>
<p>Specify the user that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"root"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamefilesuser"><a class="header" href="#preservationpreserveatnamefilesuser">preservation.preserveAt.&lt;name&gt;.files.*.user</a></h2>
<p>Specify the user that owns the file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"root"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnamepersistentstoragepath"><a class="header" href="#preservationpreserveatnamepersistentstoragepath">preservation.preserveAt.&lt;name&gt;.persistentStoragePath</a></h2>
<p>Specify the location at which the <code>directories</code>, <code>files</code>,
<code>users.directories</code> and <code>users.files</code> should be preserved.
Defaults to the name of the parent attribute set.</p>
<p><em>Type:</em>
path</p>
<p><em>Default:</em>
<code>"‚Äπname‚Ä∫"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusers"><a class="header" href="#preservationpreserveatnameusers">preservation.preserveAt.&lt;name&gt;.users</a></h2>
<p>Specify a set of users with corresponding files and directories that
should be preserved.</p>
<p><em>Type:</em>
attribute set of (submodule)</p>
<p><em>Default:</em>
<code>{ }</code></p>
<p><em>Example:</em></p>
<pre><code class="language-nix">{
  alice.directories = [ ".rabbit_hole" ];
  butz = {
    files = [
      {
        file = ".config/foo";
        mode = "0600";
      }
      "bar"
    ];
    directories = [ "unshaved_yaks" ];
  };
}
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectories"><a class="header" href="#preservationpreserveatnameusersnamedirectories">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories</a></h2>
<p>Specify a list of directories that should be preserved for this user.
The paths are interpreted relative to <code>home</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code>[
  ".rabbit_hole"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesconfigureparent"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesconfigureparent">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.configureParent</a></h2>
<p>Specify whether the parent directory of this directory shall be configured with
custom ownership and permissions.</p>
<p>By default, missing parent directories are always created with ownership
<code>root:root</code> and mode <code>0755</code>, as described in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a>.</p>
<p>Ownership and mode may be configured through the options
<code>parent.user</code>,
<code>parent.group</code>,
<code>parent.mode</code>.</p>
<p>Defaults to <code>true</code> when <code>how</code> is set to <code>symlink</code> and
<code>user</code> is not <code>root</code>.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriescreatelinktarget"><a class="header" href="#preservationpreserveatnameusersnamedirectoriescreatelinktarget">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.createLinkTarget</a></h2>
<p>Only used when <code>how</code> is set to <code>symlink</code>.</p>
<p>Specify whether to create an empty directory with the specified ownership
and permissions as target of the symlink.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesdirectory"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesdirectory">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.directory</a></h2>
<p>Specify the path to the directory that should be preserved.</p>
<p><em>Type:</em>
string</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesgroup"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesgroup">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.group</a></h2>
<p>Specify the group that owns the directory.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectorieshow"><a class="header" href="#preservationpreserveatnameusersnamedirectorieshow">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.how</a></h2>
<p>Specify how this directory should be preserved.</p>
<p><em>Type:</em>
one of ‚Äúbindmount‚Äù, ‚Äúsymlink‚Äù</p>
<p><em>Default:</em>
<code>"bindmount"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesininitrd"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesininitrd">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.inInitrd</a></h2>
<p>Whether to prepare preservation of this directory in initrd.</p>
<p><strong>Note:</strong> For most directories there is no need to enable this option.</p>
<p><strong>Important:</strong> Note that both owner and group for this directory need to be
available in the initrd for permissions to be set correctly.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesmode"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesmode">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.mode</a></h2>
<p>Specify the access mode of the directory.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesmountoptions"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesmountoptions">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.mountOptions</a></h2>
<p>Specify a list of mount options that should be used for this directory.
These options are only used when <code>how</code> is set to <code>bindmount</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em></p>
<pre><code>[
  "bind"
  "X-fstrim.notrim"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesmountoptionsname"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesmountoptionsname">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.mountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesmountoptionsvalue"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesmountoptionsvalue">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.mountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesparentgroup"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesparentgroup">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.parent.group</a></h2>
<p>Specify the group that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesparentmode"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesparentmode">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.parent.mode</a></h2>
<p>Specify the access mode of the parent directory of this file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesparentuser"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesparentuser">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.parent.user</a></h2>
<p>Specify the user that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"‚Äπuser‚Ä∫"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamedirectoriesuser"><a class="header" href="#preservationpreserveatnameusersnamedirectoriesuser">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.directories.*.user</a></h2>
<p>Specify the user that owns the directory.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"‚Äπuser‚Ä∫"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefiles"><a class="header" href="#preservationpreserveatnameusersnamefiles">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files</a></h2>
<p>Specify a list of files that should be preserved for this user.
The paths are interpreted relative to <code>home</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em>
<code>[ ]</code></p>
<p><em>Example:</em></p>
<pre><code class="language-nix">[
  {
    file = ".config/foo";
    mode = "0600";
  }
  "bar"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesconfigureparent"><a class="header" href="#preservationpreserveatnameusersnamefilesconfigureparent">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.configureParent</a></h2>
<p>Specify whether the parent directory of this file shall be configured with
custom ownership and permissions.</p>
<p>By default, missing parent directories are always created with ownership
<code>root:root</code> and mode <code>0755</code>, as described in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a>.</p>
<p>Ownership and mode may be configured through the options
<code>parent.user</code>,
<code>parent.group</code>,
<code>parent.mode</code>.</p>
<p>Defaults to <code>true</code> when <code>how</code> is set to <code>symlink</code> and
<code>user</code> is not <code>root</code>.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilescreatelinktarget"><a class="header" href="#preservationpreserveatnameusersnamefilescreatelinktarget">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.createLinkTarget</a></h2>
<p>Only used when <code>how</code> is set to <code>symlink</code>.</p>
<p>Specify whether to create an empty file with the specified ownership
and permissions as target of the symlink.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesfile"><a class="header" href="#preservationpreserveatnameusersnamefilesfile">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.file</a></h2>
<p>Specify the path to the file that should be preserved.</p>
<p><em>Type:</em>
string</p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesgroup"><a class="header" href="#preservationpreserveatnameusersnamefilesgroup">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.group</a></h2>
<p>Specify the group that owns the file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefileshow"><a class="header" href="#preservationpreserveatnameusersnamefileshow">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.how</a></h2>
<p>Specify how this file should be preserved:</p>
<ol>
<li>
<p>Either a file is placed both on the volatile and on the
persistent volume, with a bind mount from the former to the
latter.</p>
</li>
<li>
<p>Or a symlink is created on the volatile volume, pointing
to the corresponding location on the persistent volume.</p>
</li>
</ol>
<p><em>Type:</em>
one of ‚Äúbindmount‚Äù, ‚Äúsymlink‚Äù</p>
<p><em>Default:</em>
<code>"bindmount"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesininitrd"><a class="header" href="#preservationpreserveatnameusersnamefilesininitrd">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.inInitrd</a></h2>
<p>Whether to prepare preservation of this file in the initrd.</p>
<p><strong>Note:</strong> For most files there is no need to enable this option.</p>
<p><code>/etc/machine-id</code> is an exception because it needs to
be populated/read very early.</p>
<p><strong>Important:</strong> Note that both owner and group for this file need to be
available in the initrd for permissions to be set correctly.</p>
<p><em>Type:</em>
boolean</p>
<p><em>Default:</em>
<code>false</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesmode"><a class="header" href="#preservationpreserveatnameusersnamefilesmode">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.mode</a></h2>
<p>Specify the access mode of the file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0644"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesmountoptions"><a class="header" href="#preservationpreserveatnameusersnamefilesmountoptions">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.mountOptions</a></h2>
<p>Specify a list of mount options that should be used for this file.
These options are only used when <code>how</code> is set to <code>bindmount</code>.</p>
<p><em>Type:</em>
list of ((submodule) or string convertible to it)</p>
<p><em>Default:</em></p>
<pre><code>[
  "bind"
]
</code></pre>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesmountoptionsname"><a class="header" href="#preservationpreserveatnameusersnamefilesmountoptionsname">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.mountOptions.*.name</a></h2>
<p>Specify the name of the mount option.</p>
<p><em>Type:</em>
string</p>
<p><em>Example:</em>
<code>"bind"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesmountoptionsvalue"><a class="header" href="#preservationpreserveatnameusersnamefilesmountoptionsvalue">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.mountOptions.*.value</a></h2>
<p>Optionally specify a value for the mount option.</p>
<p><em>Type:</em>
null or string</p>
<p><em>Default:</em>
<code>null</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesparentgroup"><a class="header" href="#preservationpreserveatnameusersnamefilesparentgroup">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.parent.group</a></h2>
<p>Specify the group that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"config.users.users.\${defaultOwner}.group"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesparentmode"><a class="header" href="#preservationpreserveatnameusersnamefilesparentmode">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.parent.mode</a></h2>
<p>Specify the access mode of the parent directory of this file.
See the section <code>Mode</code> in <a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d(5)</code></a> for more information.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"0755"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesparentuser"><a class="header" href="#preservationpreserveatnameusersnamefilesparentuser">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.parent.user</a></h2>
<p>Specify the user that owns the parent directory of this file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"‚Äπuser‚Ä∫"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamefilesuser"><a class="header" href="#preservationpreserveatnameusersnamefilesuser">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.files.*.user</a></h2>
<p>Specify the user that owns the file.</p>
<p><em>Type:</em>
string</p>
<p><em>Default:</em>
<code>"‚Äπuser‚Ä∫"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnamehome"><a class="header" href="#preservationpreserveatnameusersnamehome">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.home</a></h2>
<p>Specify the path to the user‚Äôs home directory.</p>
<p><em>Type:</em>
path, not containing newlines or colons</p>
<p><em>Default:</em>
<code>"config.users.users.\${name}.home"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<h2 id="preservationpreserveatnameusersnameusername"><a class="header" href="#preservationpreserveatnameusersnameusername">preservation.preserveAt.&lt;name&gt;.users.&lt;name&gt;.username</a></h2>
<p>Specify the user for which the <code>directories</code> and <code>files</code>
should be persisted. Defaults to the name of the parent attribute set.</p>
<p><em>Type:</em>
string, not containing newlines or colons</p>
<p><em>Default:</em>
<code>"‚Äπuser‚Ä∫"</code></p>
<p><em>Declared by:</em></p>
<ul>
<li><a href="https://github.com/willibutz/preservation/blob/main/options.nix">options.nix</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>See <a href="./configuration-options.html">Configuration Options</a> for all available options.</p>
<h2 id="simple"><a class="header" href="#simple">Simple</a></h2>
<pre><code class="language-nix"># configuration.nix
{
  config,
  lib,
  pkgs,
  ...
}:
{
  preservation = {
    enable = true;
    preserveAt."/persistent" = {
      files = [
        # auto-generated machine ID
        { file = "/etc/machine-id"; inInitrd = true; }
      ];
      directories = [
        "/var/lib/systemd/timers"
        # NixOS user state
        "/var/lib/nixos"
        # preparing /var/log early (inInitrd) avoids a dependency cycle (see TODO.md)
        { directory = "/var/log"; inInitrd = true; }
      ];
    };
  };
}
</code></pre>
<h2 id="complex"><a class="header" href="#complex">Complex</a></h2>
<pre><code class="language-nix"># configuration.nix
{
  config,
  lib,
  pkgs,
  ...
}:
{
  preservation = {
    # the module doesn't do anything unless it is enabled
    enable = true;

    preserveAt."/persistent" = {

      # preserve system directories
      directories = [
        "/etc/secureboot"
        "/var/lib/bluetooth"
        "/var/lib/fprint"
        "/var/lib/fwupd"
        "/var/lib/libvirt"
        "/var/lib/power-profiles-daemon"
        "/var/lib/systemd/coredump"
        "/var/lib/systemd/rfkill"
        "/var/lib/systemd/timers"
        { directory = "/var/lib/nixos"; inInitrd = true; }

        # preparing /var/log early (inInitrd) avoids a dependency cycle (see TODO.md)
        { directory =  "/var/log"; inInitrd = true; }
      ];

      # preserve system files
      files = [
        { file = "/etc/machine-id"; inInitrd = true; }
        "/etc/ssh/ssh_host_ed25519_key"
        "/etc/ssh/ssh_host_rsa_key"
        "/var/lib/usbguard/rules.conf"

        # creates a symlink on the volatile root
        # creates an empty directory on the persistent volume, i.e. /persistent/var/lib/systemd
        # does not create an empty file at the symlink's target (would require `createLinkTarget = true`)
        { file = "/var/lib/systemd/random-seed"; how = "symlink"; inInitrd = true; configureParent = true; }
      ];

      # preserve user-specific files, implies ownership
      users = {
        butz = {
          directories = [
            { directory = ".ssh"; mode = "0700"; }
            ".config/syncthing"
            ".config/Element"
            ".local/state/nvim"
            ".local/state/wireplumber"
            ".local/share/direnv"
            ".local/state/nix"
            ".mozilla"
          ];
          files = [
            ".histfile"
          ];
        };
        users.root = {
          # specify user home when it is not `/home/${user}`
          home = "/root";
          directories = [
            { directory = ".ssh"; mode = "0700"; }
          ];
        };
      };
    };
  };

  # Create some directories with custom permissions.
  #
  # In this configuration the path `/home/butz/.local` is not an immediate parent
  # of any persisted file, so it would be created with the systemd-tmpfiles default
  # ownership `root:root` and mode `0755`. This would mean that the user `butz`
  # could not create other files or directories inside `/home/butz/.local`.
  #
  # Therefore systemd-tmpfiles is used to prepare such directories with
  # appropriate permissions.
  #
  # Note that immediate parent directories of persisted files can also be
  # configured with ownership and permissions from the `parent` settings if
  # `configureParent = true` is set for the file.
  systemd.tmpfiles.settings.preservation = {
    "/home/butz/.config".d = { user = "butz"; group = "users"; mode = "0755"; };
    "/home/butz/.local".d = { user = "butz"; group = "users"; mode = "0755"; };
    "/home/butz/.local/share".d = { user = "butz"; group = "users"; mode = "0755"; };
    "/home/butz/.local/state".d = { user = "butz"; group = "users"; mode = "0755"; };
  };

}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="impermanence"><a class="header" href="#impermanence">Impermanence</a></h1>
<p><a href="https://github.com/nix-community/impermanence">Impermanence</a> is the established solution for managing persistent state on NixOS systems.
Preservation is inspired and heavily influenced by impermanence.</p>
<p>See <a href="./impermanence-comparison.html">Comparison</a> for a high-level overview of their differences.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-does-preservation-compare-to-impermanence"><a class="header" href="#how-does-preservation-compare-to-impermanence">How does Preservation compare to <a href="https://github.com/nix-community/impermanence">impermanence</a></a></h1>
<h3 id="preservation-does-not-attempt-to-be-a-very-generic-solution"><a class="header" href="#preservation-does-not-attempt-to-be-a-very-generic-solution">Preservation does not attempt to be a very generic solution</a></h3>
<p>Preservation tries to fill a specific niche.
For instance, Preservation does not support non-NixOS systems via home-manager, which is supported
by impermanence. See <a href="./impermanence-migration.html">Migration</a> for more technical details.</p>
<h3 id="preservation-only-generates-static-configuration"><a class="header" href="#preservation-only-generates-static-configuration">Preservation only generates static configuration</a></h3>
<p>That is configuration for <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd-tmpfiles.html">systemd-tmpfiles</a>
and systemd <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.mount.html">mount units</a>.
This makes Preservation a potential candidate for state management on interpreter-less NixOS systems.</p>
<p>Impermanence makes use of NixOS activation scripts and custom systemd services with bash (at the point
of writing this), to create files and directories, setup mounts and configure ownership and permissions (see next point).</p>
<h3 id="preservation-must-be-precisely-configured"><a class="header" href="#preservation-must-be-precisely-configured">Preservation must be precisely configured</a></h3>
<p>There is no <a href="https://github.com/nix-community/impermanence/blob/23c1f06316b67cb5dabdfe2973da3785cfe9c34a/mount-file.bash#L31-L42">special runtime logic</a>
in place. This means that the user must define:</p>
<ul>
<li>when the preservation should be set up: either in the initrd, or after (the default)</li>
<li>how the preservation should be set up: either by symlink, or bindmount (the default)</li>
<li>whether or not parent directories of the persisted files require special permissions</li>
</ul>
<p>See <a href="./impermanence-migration.html">Migration</a> for specifics that need to be considered when coming from an impermanence setup.</p>
<h3 id="similar-configuration"><a class="header" href="#similar-configuration">Similar configuration</a></h3>
<p>Preservation's configuration is based on, and very similar to that of impermanence. See <a href="./impermanence-migration.html">Migration</a> for technical details.</p>
<h3 id="global-enable-option"><a class="header" href="#global-enable-option">Global <code>enable</code> option</a></h3>
<p>Preservation uses a global <code>enable</code> option, impermanence does not.</p>
<p>For thoughts on the <code>enable</code> option, see the discussion at <a href="https://github.com/nix-community/impermanence/pull/171">https://github.com/nix-community/impermanence/pull/171</a> and for available configuration options see <a href="./configuration-options.html">Configuration Options</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="migration-from-impermanence-to-preservation"><a class="header" href="#migration-from-impermanence-to-preservation">Migration from impermanence to Preservation</a></h1>
<p>This section lists individual differences between impermanence and
Preservation, to better understand them in context of a complete configuration
<a href="./examples.html">Examples</a> may be helpful.</p>
<p>The following points need to be considered when migrating an existing
impermanence configuration to Preservation:</p>
<h3 id="global-enable-switch"><a class="header" href="#global-enable-switch">Global <code>enable</code> switch</a></h3>
<p>The module must be explicitly enabled by setting <code>preservation.enable</code> to <code>true</code>.</p>
<h3 id="when-to-persist"><a class="header" href="#when-to-persist">When to persist</a></h3>
<p>Files and directories that need to be persisted early, must be explicitly configured. For example <code>/etc/machine-id</code>:</p>
<p>This file needs to be persisted very early, by explicitly setting <code>inInitrd</code> to <code>true</code>:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  { file = "/etc/machine-id"; inInitrd = true; }
];
</code></pre>
<h3 id="how-to-persist"><a class="header" href="#how-to-persist">How to persist</a></h3>
<p>The mode of preservation must be set explicitly for some files and directories.
This can be done by setting <code>how</code> to either <code>symlink</code> or <code>bindmount</code> (default).
For most cases the default is sufficient but sometimes a symlink may be needed,
for example <code>/var/lib/systemd/random-seed</code>.</p>
<p>This file is expected to not exist before it is initialized. A symlink can be
used to cause its creation to happen on the persistent volume:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  {
    file = "/var/lib/systemd/random-seed";
    # create a symlink on the volatile volume
    how = "symlink";
    # prepare the preservation early during startup
    inInitrd = true;
  }
];
</code></pre>
<p>Note that no file is created at the symlink's target, unless <code>createLinkTarget</code> is set to <code>true</code>.</p>
<h3 id="configuration-of-intermediate-path-components"><a class="header" href="#configuration-of-intermediate-path-components">Configuration of intermediate path components</a></h3>
<p>Preservation does not handle any files or directories other than those specifically configured
to be preserved, and optionally their immediate parent directories (via <code>configureParent</code> and
the <code>parent</code> options).</p>
<p>All missing components of a preserved path that do not already exist, are created by
systemd-tmpfiles with default ownership <code>root:root</code> and mode <code>0755</code>.</p>
<p>Should such directories require different ownership or mode, the intended way to provision them
is directly via systemd-tmpfiles.</p>
<p><strong>Example</strong></p>
<p>Consider a preserved file <code>/foo/bar/baz</code>:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  { file = "/foo/bar/baz"; user = "baz"; group = "baz"; };
];
</code></pre>
<p>This would create the file with desired ownership on both the volatile and persistent volumes.
However, the parent directories that did not exist before, i.e. <code>/foo</code> and <code>/foo/bar</code>, are
created with ownership <code>root:root</code> and mode <code>0755</code>.</p>
<p>Preservations allows the configuration of immediate parents, so the permissions for <code>/foo/bar</code>
can be configured:</p>
<pre><code class="language-nix">preservation.preserveAt."/persistent".files = [
  {
    file = "/foo/bar/baz"; user = "baz"; group = "baz";
    configureParent = true;
    parent.user = "baz";
    parent.group = "bar";
  };
];
</code></pre>
<p>Now the parent directory <code>/foo/bar</code> is configured with ownership <code>baz:bar</code>. But the first
path component <code>/foo</code> still has systemd-tmpfiles' default ownership and the configuration
becomes quite convoluted.</p>
<p><strong>Solution</strong></p>
<p>To create or configure intermediate path components of a persisted path, systemd-tmpfiles
may be used directly:</p>
<pre><code class="language-nix"># configure preservation of single file
preservation.preserveAt."/persistent".files = [
  { file = "/foo/bar/baz"; user = "baz"; group = "bar"; };
];

# create and configure parents of preserved file on the volatile volume with custom permissions
# The Preservation module also uses `settings.preservation` here.
systemd.tmpfiles.settings.preservation = {
  "/foo".d = { user = "foo"; group = "bar"; mode = "0775"; };
  "/foo/bar".d = { user = "bar"; group = "bar"; mode = "0755"; };
};
</code></pre>
<p>See <a href="https://www.freedesktop.org/software/systemd/man/latest/tmpfiles.d.html">tmpfiles.d(5)</a>
for available configuration options.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="library-and-testing"><a class="header" href="#library-and-testing">Library and Testing</a></h1>
<h2 id="library"><a class="header" href="#library">Library</a></h2>
<p>The functionality that is used in the module to discover the files and
directories that are persisted and to generate the corresponding tmpfiles
config and mount units is available from <a href="../../lib.nix"><code>lib.nix</code></a>.
It is also available from the flake <code>lib</code> output.</p>
<p>In both cases it needs to be instantiated with the nixpkgs <code>lib</code>.</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>The integration test(s) can be found in <a href="../../tests">/tests</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
